name: Build nuget package and test dll
description: "Builds signed nuget package"

inputs:
  sgKey:
    required: true

runs:
  using: "composite"
  steps:
    - name: Restore dependencies
      shell: pwsh
      run: dotnet restore
    
    - name: Build
      shell: pwsh
      run: dotnet build --configuration Release --no-restore
    
    # Initializes the CodeQL tools for scanning.
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # If you wish to specify custom queries, you can do so here or in a config file.
        # By default, queries listed here will override any specified in a config file.
        # Prefix the list here with "+" to use these queries and those in the config file.
        
        # Details on CodeQL's query packs refer to : https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
        # queries: security-extended,security-and-quality
    
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      
    - name: Create Code Signing Key
      shell: pwsh
      run: |
        New-Item -ItemType directory -Path key
        Set-Content -Path key\key.txt -Value '${{ inputs.sgKey }}'
        certutil -decode key\key.txt key\key.snk
            
    - name: Delay Sign dll
      shell: pwsh
      run: sn -R ./AerospikeClient/bin/Release/net6.0/AerospikeClient.dll key.snk
    
    - name: Create nuget packages
      shell: pwsh
      run: dotnet pack --no-build
        
    #- name: Sign nuget packages
