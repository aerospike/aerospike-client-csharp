name: Build nuget package and test dll
description: "Builds signed nuget package"

inputs:
  sgKey:
    required: true

runs:
  using: "composite"
  steps:
    - name: Restore dependencies
      shell: pwsh
      run: dotnet restore

    - name: Build
      shell: pwsh
      run: dotnet build --configuration Release --no-restore

    - name: Create Code Signing Key
      shell: pwsh
      run: |
        New-Item -ItemType directory -Path key
        Set-Content -Path key\key.txt -Value '${{ inputs.sgKey }}'
        certutil -decode key\key.txt key\key.snk

    - name: Delay Sign dll
      shell: pwsh
      run: |
        & 'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8.1 Tools\sn.exe' -R .\AerospikeClient\bin\Release\net6.0\AerospikeClient.dll key\key.snk

    - name: Create nuget packages
      shell: pwsh
      run: dotnet pack --no-build

    - name: Setup JFrog CLI
      id: setup-jfrog-cli
      uses: jfrog/setup-jfrog-cli@v4.4.2
      env:
        JF_URL: https://aerospike.jfrog.io
      with:
        oidc-provider-name: gh-aerospike-clients
        oidc-audience: aerospike/clients

    - name: Configure NuGet repository
      shell: pwsh
      working-directory: AerospikeClient\bin\Release
      run: |
        jf nuget-config --repo-resolve database-nuget-dev-local --repo-deploy database-nuget-dev-local

    # - name: Sign nuget packages

    - name: Deploy release
      shell: pwsh
      working-directory: AerospikeClient\bin\Release
      run: |
        jf dotnet nuget push Aerospike.Client.* --build-name=${{ github.repository }} --build-number=${{ github.run_number }}

    - name: Deploy test
      shell: pwsh
      working-directory: AerospikeTest\bin\Release\net8.0
      run: |
        jf rt upload AerospikeTest.dll database-generic-dev-local/
