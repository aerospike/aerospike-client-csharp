name: Build nuget package and test dll
description: "Builds signed nuget package"

inputs:
  sgKey:
    required: true

runs:
  using: "composite"
  steps:
    - name: Build Core
      shell: pwsh
      working-directory: Core
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Build Framework
      shell: pwsh
      working-directory: Framework
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore

    - name: Create Code Signing Key
      shell: pwsh
      run: |
        New-Item -ItemType directory -Path key
        Set-Content -Path key\key.txt -Value '${{ inputs.sgKey }}'
        certutil -decode key\key.txt key\key.snk

    - name: Delay Sign dlls
      shell: pwsh
      run: |
        & 'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8.1 Tools\sn.exe' -R .\Core\AerospikeClient\bin\Release\netstandard2.0\AerospikeClient.dll key\key.snk
        & 'C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8.1 Tools\sn.exe' -R .Framework\AerospikeClient\bin\Release\AerospikeClient.dll key\key.snk

    - name: Create nuget packages
      shell: pwsh
      run: nuget pack .\AerospikeClient.nuspec
      
    - name: Rename nuget package
      shell: pwsh
      run : Get-ChildItem -File | Rename-Item -NewName { $_.Name -replace 'Aerospike\.Client\.([0-9]+)\.([0-9]+)\.([0-9]+)([a-zA-Z-]*).nupkg', 'Aerospike.Client.$1.$2.$3$4-${{ github.run_number }}.nupkg' }
    
    #- name: Rename snuget package
    #  shell: pwsh
    #  working-directory: AerospikeClient\bin\Release
    #  run : Get-ChildItem -File | Rename-Item -NewName { $_.Name -replace 'Aerospike\.Client\.([0-9]+)\.([0-9]+)\.([0-9]+)([a-zA-Z-]*).snupkg', 'Aerospike.Client.$1.$2.$3$4-${{ github.run_number }}.snupkg' }

    - name: Publish test project
      shell: pwsh
      working-directory: Core\AerospikeTest
      run: dotnet publish AerospikeTest.csproj --no-restore --no-build --self-contained

    - name: Zip it up
      shell: pwsh
      working-directory: Core\AerospikeTest\bin\Release\netcoreapp2.0
      run: 7z a -tzip AerospikeTest-${{ github.run_number }}.zip publish

    - name: Upload client artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AerospikeClient-${{ github.run_number }}
        path: AerospikeClient\bin\Release\Aerospike.Client.*nupkg
        retention-days: 1

    - name: Upload test artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AerospikeTest-${{ github.run_number }}
        path: AerospikeTest\bin\Release\net8.0\AerospikeTest-*
        retention-days: 1
